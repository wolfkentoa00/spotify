<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web App Remake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Figtree', sans-serif;
            background-color: black;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: hsla(0,0%,100%,.3);
            border-radius: 20px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: hsla(0,0%,100%,.5);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #4d4d4d;
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: white;
            margin-top: -4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .group:hover input[type=range]::-webkit-slider-thumb {
            opacity: 1;
        }
        
        /* Animations */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- HIDDEN YOUTUBE PLAYER -->
    <div id="youtube-player" class="hidden fixed top-0 left-0 w-1 h-1 opacity-0 pointer-events-none"></div>

    <!-- TOP VIEWPORT -->
    <div class="flex flex-1 overflow-hidden p-2 gap-2">
        
        <!-- LEFT SIDEBAR -->
        <nav class="flex flex-col gap-2 w-[280px] hidden md:flex h-full">
            <div class="bg-[#121212] rounded-lg p-5 flex flex-col gap-5">
                <button onclick="router('home')" class="nav-btn flex items-center gap-4 font-bold text-[#b3b3b3] hover:text-white transition-colors" data-page="home">
                    <i data-lucide="home" class="w-6 h-6"></i> Home
                </button>
                <button onclick="router('search')" class="nav-btn flex items-center gap-4 font-bold text-[#b3b3b3] hover:text-white transition-colors" data-page="search">
                    <i data-lucide="search" class="w-6 h-6"></i> Search
                </button>
            </div>

            <div class="flex-1 bg-[#121212] rounded-lg flex flex-col overflow-hidden">
                <div class="p-4 shadow-md z-10">
                    <div class="flex justify-between items-center text-[#b3b3b3] mb-4">
                        <button class="flex items-center gap-2 hover:text-white transition-colors font-bold group">
                            <i data-lucide="library" class="w-6 h-6 group-hover:text-white"></i> Your Library
                        </button>
                        <div class="flex gap-2">
                            <button class="hover:bg-[#2a2a2a] p-1 rounded-full hover:text-white transition"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            <button class="hover:bg-[#2a2a2a] p-1 rounded-full hover:text-white transition"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                        <span class="px-3 py-1 bg-[#232323] hover:bg-[#2a2a2a] rounded-full text-sm font-medium whitespace-nowrap cursor-pointer transition-colors">Playlists</span>
                        <span class="px-3 py-1 bg-[#232323] hover:bg-[#2a2a2a] rounded-full text-sm font-medium whitespace-nowrap cursor-pointer transition-colors">Artists</span>
                        <span class="px-3 py-1 bg-[#232323] hover:bg-[#2a2a2a] rounded-full text-sm font-medium whitespace-nowrap cursor-pointer transition-colors">Albums</span>
                    </div>
                </div>
                
                <!-- Library List Container -->
                <div id="library-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                    <!-- JS Injected -->
                </div>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="flex-1 bg-[#121212] rounded-lg relative overflow-hidden flex flex-col">
            <!-- Header -->
            <header id="main-header" class="h-[64px] absolute top-0 w-full z-20 flex items-center justify-between px-6 transition-colors duration-300 bg-transparent">
                <div class="flex gap-2 items-center">
                    <button class="bg-black/70 rounded-full p-1 text-[#b3b3b3] cursor-not-allowed"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <button class="bg-black/70 rounded-full p-1 text-[#b3b3b3] cursor-not-allowed"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                    
                    <!-- Search Input (Hidden by default) -->
                    <div id="search-input-container" class="hidden ml-4 relative group">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-[#b3b3b3] w-5 h-5"></i>
                        <input id="search-input" type="text" placeholder="What do you want to play?" 
                            class="bg-[#242424] hover:bg-[#2a2a2a] focus:bg-[#2a2a2a] focus:ring-2 focus:ring-white rounded-full py-3 pl-10 pr-4 w-[300px] text-sm text-white placeholder-[#757575] outline-none transition-all">
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="bg-white text-black text-sm font-bold px-4 py-1.5 rounded-full hover:scale-105 transition-transform hidden sm:block">Explore Premium</button>
                    <button class="bg-[#0f0f0f] p-2 rounded-full hover:bg-[#1f1f1f] hover:scale-105 transition-transform text-[#b3b3b3] hover:text-white"><i data-lucide="bell" class="w-5 h-5"></i></button>
                    <button class="bg-[#0f0f0f] p-1.5 rounded-full hover:bg-[#1f1f1f] hover:scale-105 transition-transform">
                        <div class="h-7 w-7 bg-orange-600 rounded-full flex items-center justify-center text-xs font-bold text-black border-2 border-black">D</div>
                    </button>
                </div>
            </header>

            <!-- Views Container -->
            <div id="main-scroll" class="flex-1 overflow-y-auto custom-scrollbar pt-[64px]">
                <div id="home-view" class="block">
                    <!-- Dynamic Home Content -->
                </div>
                <div id="search-view" class="hidden px-6 pt-4 pb-8">
                    <!-- Dynamic Search Content -->
                </div>
                
                <!-- Footer Links -->
                <div class="px-8 pb-8 pt-12 grid grid-cols-2 md:grid-cols-4 gap-8 text-sm text-[#b3b3b3] mt-8">
                    <div class="flex flex-col gap-2">
                        <span class="text-white font-bold mb-2">Company</span>
                        <span class="hover:text-white hover:underline cursor-pointer">About</span>
                        <span class="hover:text-white hover:underline cursor-pointer">Jobs</span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <span class="text-white font-bold mb-2">Communities</span>
                        <span class="hover:text-white hover:underline cursor-pointer">For Artists</span>
                        <span class="hover:text-white hover:underline cursor-pointer">Developers</span>
                    </div>
                    <div class="flex flex-col gap-2">
                         <span class="text-white font-bold mb-2">Useful links</span>
                         <span class="hover:text-white hover:underline cursor-pointer">Support</span>
                    </div>
                 </div>
            </div>
        </main>

        <!-- RIGHT SIDEBAR (Now Playing) -->
        <aside id="right-sidebar" class="w-[280px] bg-[#121212] rounded-lg p-4 hidden xl:flex flex-col">
            <div class="flex justify-between items-center mb-6 text-[#b3b3b3]">
                <span class="font-bold hover:text-white cursor-pointer" id="queue-title">Queue</span>
                <button onclick="toggleRightSidebar()"><i data-lucide="x" class="w-5 h-5 hover:text-white"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <img id="side-cover" src="" class="w-full aspect-square rounded-lg shadow-lg mb-4 object-cover">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h2 id="side-title" class="text-2xl font-bold hover:underline cursor-pointer text-white">Title</h2>
                        <span id="side-artist" class="text-[#b3b3b3] font-medium hover:underline hover:text-white cursor-pointer">Artist</span>
                    </div>
                    <i data-lucide="heart" class="w-6 h-6 text-[#1ed760] fill-[#1ed760]"></i>
                </div>
                
                <!-- Artist Card -->
                <div class="bg-[#242424] rounded-lg overflow-hidden mt-4 relative group">
                    <div class="absolute top-4 left-4 font-bold text-white z-10">About the artist</div>
                    <img id="side-artist-img" src="" class="w-full h-40 object-cover opacity-60 group-hover:scale-105 transition-transform duration-500">
                    <div class="p-4 relative bg-[#242424]">
                        <h3 id="side-artist-name" class="font-bold text-white mb-2">Artist</h3>
                        <div class="flex justify-between text-[#b3b3b3] text-sm">
                            <span>25,234,221 listeners</span>
                            <button class="border border-[#b3b3b3] rounded-full px-3 py-1 hover:border-white hover:text-white font-bold">Follow</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- PLAYER FOOTER -->
    <footer class="h-[90px] bg-black border-t border-[#282828] px-4 flex justify-between items-center z-30">
        <!-- Track Info -->
        <div class="flex items-center gap-4 w-[30%] min-w-[180px]">
            <div class="relative group">
                <img id="player-cover" src="" class="h-14 w-14 rounded shadow-sm cursor-pointer hover:opacity-80 transition-opacity" onclick="toggleFullScreen(true)">
                <button onclick="toggleFullScreen(true)" class="absolute top-1 right-1 bg-black/50 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="maximize-2" class="w-3 h-3 text-white"></i>
                </button>
            </div>
            <div class="flex flex-col justify-center overflow-hidden mr-2">
                <span id="player-title" class="text-sm font-medium text-white hover:underline cursor-pointer truncate">Title</span>
                <span id="player-artist" class="text-xs text-[#b3b3b3] hover:underline hover:text-white cursor-pointer truncate">Artist</span>
            </div>
            <button class="text-[#b3b3b3] hover:text-white hidden lg:block"><i data-lucide="heart" class="w-4 h-4"></i></button>
        </div>

        <!-- Controls -->
        <div class="flex flex-col items-center max-w-[40%] w-full gap-2">
            <div class="flex items-center gap-6">
                <button onclick="toggleShuffle()" id="btn-shuffle" class="text-[#b3b3b3] hover:text-white transition-colors"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
                <button onclick="playPrev()" class="text-[#b3b3b3] hover:text-white"><i data-lucide="skip-back" class="w-5 h-5 fill-current"></i></button>
                <button onclick="togglePlay()" id="btn-play-pause" class="bg-white rounded-full p-2 hover:scale-105 transition-transform flex items-center justify-center">
                    <i data-lucide="play" class="w-5 h-5 fill-black text-black ml-0.5"></i>
                </button>
                <button onclick="playNext()" class="text-[#b3b3b3] hover:text-white"><i data-lucide="skip-forward" class="w-5 h-5 fill-current"></i></button>
                <button onclick="toggleRepeat()" id="btn-repeat" class="text-[#b3b3b3] hover:text-white transition-colors"><i data-lucide="repeat" class="w-4 h-4"></i></button>
            </div>
            <div class="w-full flex items-center gap-2 text-xs font-mono text-[#b3b3b3]">
                <span id="current-time">0:00</span>
                <div class="relative w-full group flex items-center h-4">
                    <div class="absolute w-full h-1 bg-[#4d4d4d] rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-white group-hover:bg-[#1ed760] w-0"></div>
                    </div>
                    <input type="range" min="0" max="100" value="0" class="absolute w-full h-full opacity-0 cursor-pointer z-10" id="seek-slider">
                </div>
                <span id="total-time">0:00</span>
            </div>
        </div>

        <!-- Volume & Extras -->
        <div class="flex items-center justify-end gap-3 w-[30%] min-w-[180px]">
            <button onclick="toggleRightSidebar()" class="text-[#b3b3b3] hover:text-white hidden md:block"><i data-lucide="play-square" class="w-4 h-4"></i></button>
            <button class="text-[#b3b3b3] hover:text-white hidden md:block"><i data-lucide="mic-2" class="w-4 h-4"></i></button>
            <button class="text-[#b3b3b3] hover:text-white hidden md:block"><i data-lucide="list-music" class="w-4 h-4"></i></button>
            <button class="text-[#b3b3b3] hover:text-white hidden md:block"><i data-lucide="monitor-speaker" class="w-4 h-4"></i></button>
            <div class="flex items-center gap-2 w-24 group">
                <i id="volume-icon" data-lucide="volume-2" class="w-4 h-4 text-[#b3b3b3]"></i>
                <div class="h-1 bg-[#4d4d4d] rounded-full flex-1 overflow-hidden relative">
                    <div id="volume-bar" class="absolute h-full bg-white group-hover:bg-[#1ed760]" style="width: 80%"></div>
                    <input type="range" min="0" max="100" value="80" class="absolute w-full h-full opacity-0 cursor-pointer z-10" id="volume-slider">
                </div>
            </div>
            <button onclick="toggleFullScreen(true)" class="text-[#b3b3b3] hover:text-white"><i data-lucide="maximize-2" class="w-4 h-4"></i></button>
        </div>
    </footer>

    <!-- FULL SCREEN OVERLAY -->
    <div id="fullscreen-overlay" class="fixed inset-0 z-50 flex-col bg-black text-white p-8 hidden animate-fade-in">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black opacity-90 pointer-events-none" id="fs-gradient"></div>
        <div class="relative z-10 flex justify-between items-center mb-8">
            <div class="flex items-center gap-2 text-white/70">
                <span class="text-xs font-bold tracking-widest uppercase">Playing from playlist</span>
                <span class="text-xs font-bold">Top Hits 2024</span>
            </div>
            <button onclick="toggleFullScreen(false)" class="hover:bg-white/10 p-2 rounded-full"><i data-lucide="minimize-2" class="w-6 h-6"></i></button>
        </div>
        
        <div class="relative z-10 flex-1 flex flex-col md:flex-row items-center justify-center gap-12 pb-12">
            <img id="fs-cover" src="" class="w-[300px] h-[300px] md:w-[500px] md:h-[500px] object-cover rounded-xl shadow-2xl">
            <div class="flex flex-col gap-6 md:w-[400px]">
                <div>
                    <h1 id="fs-title" class="text-4xl md:text-6xl font-bold mb-2">Title</h1>
                    <h2 id="fs-artist" class="text-xl md:text-2xl text-white/70">Artist</h2>
                </div>
                <!-- FS Progress -->
                <div class="w-full h-1.5 bg-white/20 rounded-full overflow-hidden mt-4">
                    <div id="fs-progress-bar" class="h-full bg-white w-0"></div>
                </div>
                <div class="flex justify-between text-xs font-medium text-white/70">
                    <span id="fs-current-time">0:00</span>
                    <span id="fs-total-time">0:00</span>
                </div>
                <!-- FS Controls -->
                <div class="flex justify-between items-center mt-4">
                    <i data-lucide="shuffle" class="w-6 h-6 text-white/70 cursor-pointer hover:text-white"></i>
                    <i onclick="playPrev()" data-lucide="skip-back" class="w-8 h-8 fill-white cursor-pointer hover:scale-110 transition"></i>
                    <button onclick="togglePlay()" id="fs-play-btn" class="bg-white text-black p-4 rounded-full hover:scale-105 transition">
                        <i data-lucide="play" class="w-8 h-8 fill-black ml-1"></i>
                    </button>
                    <i onclick="playNext()" data-lucide="skip-forward" class="w-8 h-8 fill-white cursor-pointer hover:scale-110 transition"></i>
                    <i data-lucide="repeat" class="w-6 h-6 text-white/70 cursor-pointer hover:text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // Load YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // --- DATA ---
        let SONGS = [
            { id: 1, title: "Cruel Summer", artist: "Taylor Swift", album: "Lover", duration: 178, cover: "https://is1-ssl.mzstatic.com/image/thumb/Music115/v4/39/3c/65/393c65e8-e565-d064-071a-6379c1485c2c/19UMGIM53909.rgb.jpg/600x600bb.jpg", color: "from-pink-500", hex: "#ec4899", youtubeId: "ic8j13piAhQ" },
            { id: 2, title: "Starboy", artist: "The Weeknd", album: "Starboy", duration: 230, cover: "https://is1-ssl.mzstatic.com/image/thumb/Music125/v4/4b/32/34/4b3234f2-9844-486a-7d9a-1c7fa1544dd0/16UMGIM48521.rgb.jpg/600x600bb.jpg", color: "from-red-600", hex: "#dc2626", youtubeId: "34Na4j8AVgA" },
            { id: 3, title: "As It Was", artist: "Harry Styles", album: "Harry's House", duration: 167, cover: "https://is1-ssl.mzstatic.com/image/thumb/Music112/v4/3e/04/eb/3e04ebf6-370f-f59d-ec84-2c2643db92f1/196589560625.jpg/600x600bb.jpg", color: "from-blue-400", hex: "#60a5fa", youtubeId: "H5v3kku4y6Q" },
            { id: 4, title: "Flowers", artist: "Miley Cyrus", album: "Endless Summer Vacation", duration: 200, cover: "https://is1-ssl.mzstatic.com/image/thumb/Music113/v4/64/07/78/640778c8-b52e-c350-13b6-97699318a666/196589561059.jpg/600x600bb.jpg", color: "from-amber-500", hex: "#f59e0b", youtubeId: "G7KNmW9a75Y" }
        ];

        const PLAYLISTS = [
            { id: 1, name: "Liked Songs", owner: "You", cover: "https://misc.scdn.co/liked-songs/liked-songs-640.png", type: "Playlist" },
            { id: 2, name: "Discover Weekly", owner: "Spotify", cover: "https://newjams-images.scdn.co/image/ab676477000033ad/dt/v3/discover-weekly/aAbca4VNfzWuUCQ_FGiEFA==/bmVuZW5lbmVuZW5lbmVuZQ==", type: "Playlist" },
            { id: 3, name: "On Repeat", owner: "Spotify", cover: "https://daily-mix.scdn.co/covers/on_repeat_PPM_DEFAULT_large_en.jpg", type: "Playlist" },
            { id: 4, name: "Daily Mix 1", owner: "Spotify", cover: "https://dailymix-images.scdn.co/v2/img/ab6761610000e5ebcfc6347e3a992850942544e3/1/en/default", type: "Playlist" },
            { id: 5, name: "Release Radar", owner: "Spotify", cover: "https://newjams-images.scdn.co/v3/release-radar/ab6761610000e5ebcfc6347e3a992850942544e3/en/large", type: "Playlist" },
            { id: 6, name: "Top Hits 2024", owner: "Spotify", cover: "https://charts-images.scdn.co/assets/locale_en/regional/weekly/region_global_default.jpg", type: "Playlist" },
        ];

        const CATEGORIES = [
            { id: "podcasts", name: "Podcasts", color: "bg-red-500" },
            { id: "live", name: "Live Events", color: "bg-purple-500" },
            { id: "madeforyou", name: "Made For You", color: "bg-blue-800" },
            { id: "new", name: "New Releases", color: "bg-pink-500" },
            { id: "pop", name: "Pop", color: "bg-green-500" },
            { id: "hiphop", name: "Hip-Hop", color: "bg-orange-500" },
            { id: "rock", name: "Rock", color: "bg-red-700" },
            { id: "latin", name: "Latin", color: "bg-yellow-500" }
        ];

        // --- STATE ---
        let currentTrack = SONGS[0];
        let isPlaying = false;
        let progress = 0;
        let progressInterval;
        let isShuffle = false;
        let isRepeat = false;
        let currentView = 'home';
        let player; // YouTube Player Instance
        let debounceTimer;
        
        // --- DOM ELEMENTS ---
        const homeView = document.getElementById('home-view');
        const searchView = document.getElementById('search-view');
        const mainHeader = document.getElementById('main-header');
        const searchInputContainer = document.getElementById('search-input-container');
        const searchInput = document.getElementById('search-input');
        
        // --- INIT ---
        window.onload = () => {
            renderLibrary();
            renderHome();
            renderSearch(); // Pre-render search
            loadTrackDataOnly(currentTrack); // Load initial visual data
            lucide.createIcons();
            
            // Scroll Listener
            document.getElementById('main-scroll').addEventListener('scroll', (e) => {
                const opacity = Math.min(e.target.scrollTop / 200, 1);
                mainHeader.style.backgroundColor = `rgba(18, 18, 18, ${opacity})`;
            });

            // Search Listener with Debounce
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.toLowerCase();
                    if(query.length > 1) {
                         searchITunes(query);
                    } else {
                        renderSearch('');
                    }
                }, 400); // 400ms debounce
            });
        };

        // --- ITUNES & YOUTUBE API LOGIC ---

        async function searchITunes(term) {
             const html = `
                <div class="flex gap-2 mb-6">
                    <button class="px-3 py-1 bg-white text-black rounded-full text-sm font-medium">All</button>
                    <button class="px-3 py-1 bg-[#2a2a2a] text-white hover:bg-[#3a3a3a] rounded-full text-sm font-medium">Songs</button>
                </div>
                <div class="text-center mt-12"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>
             `;
             searchView.innerHTML = html;

             try {
                 const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&entity=song&limit=20`);
                 const data = await res.json();
                 
                 const results = data.results.map((track, i) => ({
                    id: track.trackId,
                    title: track.trackName,
                    artist: track.artistName,
                    album: track.collectionName,
                    cover: track.artworkUrl100.replace('100x100', '600x600'),
                    duration: track.trackTimeMillis / 1000,
                    color: "from-gray-700", // Default color
                    hex: "#374151",
                    preview: track.previewUrl, // M4A preview 30s
                    // We don't have YouTube ID yet, we fetch it on click
                 }));
                 
                 renderSearchResults(results, term);

             } catch (e) {
                 console.error(e);
                 searchView.innerHTML = `<div class="text-white pt-8">Error fetching songs. Please try again.</div>`;
             }
        }

        async function findYouTubeId(track) {
            // Uses a public Invidious/Piped instance to find video ID without API Key
            try {
                const query = `${track.title} ${track.artist} audio`;
                const res = await fetch(`https://pipedapi.kavin.rocks/search?q=${encodeURIComponent(query)}&filter=music_songs`);
                const data = await res.json();
                if(data.items && data.items.length > 0) {
                    // Find first video
                    const videoId = data.items[0].url.split('v=')[1];
                    return videoId;
                }
            } catch(e) {
                console.warn("Piped API failed, trying fallback...", e);
            }
            return null;
        }

        // --- YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '0',
                width: '0',
                videoId: currentTrack.youtubeId,
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'fs': 0,
                    'rel': 0,        // No related videos
                    'modestbranding': 1 // Cleaner UI
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Player is ready
            updateVolumeUI();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                updatePlayIcons();
                startTimer();
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                updatePlayIcons();
                stopTimer();
            } else if (event.data == YT.PlayerState.ENDED) {
                if (isRepeat) {
                    player.seekTo(0);
                    player.playVideo();
                } else {
                    playNext();
                }
            }
        }

        // --- ROUTING ---
        function router(page) {
            currentView = page;
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.classList.toggle('text-white', btn.dataset.page === page);
                btn.classList.toggle('text-[#b3b3b3]', btn.dataset.page !== page);
            });

            if (page === 'home') {
                homeView.style.display = 'block';
                searchView.style.display = 'none';
                searchInputContainer.classList.add('hidden');
            } else if (page === 'search') {
                homeView.style.display = 'none';
                searchView.style.display = 'block';
                searchInputContainer.classList.remove('hidden');
                searchInput.focus();
            }
        }

        // --- RENDERERS ---
        function renderLibrary() {
            const container = document.getElementById('library-list');
            container.innerHTML = PLAYLISTS.map(p => `
                <div class="flex gap-3 p-2 rounded-md hover:bg-[#1a1a1a] cursor-pointer group transition-colors">
                    <img src="${p.cover}" class="h-12 w-12 rounded object-cover">
                    <div class="flex flex-col justify-center overflow-hidden">
                        <h4 class="font-normal text-white truncate group-hover:text-white">${p.name}</h4>
                        <div class="flex items-center gap-1 text-[#b3b3b3] text-sm">
                            <span class="truncate">${p.type} â€¢ ${p.owner}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Filler
            for(let i=0; i<5; i++) {
                container.innerHTML += `
                <div class="flex gap-3 p-2 rounded-md opacity-30">
                     <div class="h-12 w-12 bg-[#282828] rounded"></div>
                     <div class="flex flex-col justify-center gap-2 w-full">
                         <div class="h-3 w-3/4 bg-[#282828] rounded"></div>
                     </div>
                </div>`;
            }
        }

        function renderHome() {
            homeView.innerHTML = `
                <!-- Gradient -->
                <div class="absolute top-0 left-0 w-full h-[350px] bg-gradient-to-b ${currentTrack.color} to-[#121212] opacity-40 pointer-events-none z-0 transition-colors duration-1000" id="home-gradient"></div>
                
                <div class="relative z-10 px-6 pt-6">
                    <h2 class="text-3xl font-bold text-white mb-6">${getGreeting()}</h2>
                    
                    <!-- Top Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-8">
                        ${PLAYLISTS.slice(0,6).map(p => `
                            <div class="group flex items-center bg-[#2b2b2b]/40 hover:bg-[#2b2b2b] rounded overflow-hidden cursor-pointer transition-colors duration-300">
                                <img src="${p.cover}" class="h-16 w-16 object-cover shadow-lg">
                                <span class="font-bold text-white px-4 flex-1 truncate">${p.name}</span>
                                <div class="bg-[#1ed760] rounded-full p-3 mr-4 opacity-0 group-hover:opacity-100 shadow-xl scale-95 group-hover:scale-100 transition-all flex items-center justify-center">
                                    <i data-lucide="play" class="w-5 h-5 fill-black text-black ml-0.5"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${renderSection("Made For You", PLAYLISTS)}
                    ${renderSection("Your Top Mixes", PLAYLISTS.slice().reverse())}
                </div>
            `;
            lucide.createIcons();
        }

        function renderSection(title, items) {
            return `
                <div class="mb-8">
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-2xl font-bold text-white hover:underline cursor-pointer">${title}</h2>
                        <span class="text-sm font-bold text-[#b3b3b3] hover:underline cursor-pointer uppercase tracking-wider">Show all</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        ${items.map(item => `
                            <div class="group bg-[#181818] p-4 rounded-lg hover:bg-[#282828] transition-all duration-300 cursor-pointer flex flex-col gap-4 relative">
                                <div class="relative shadow-lg rounded-md overflow-hidden aspect-square">
                                    <img src="${item.cover}" class="w-full h-full object-cover rounded-md">
                                    <div class="absolute bottom-2 right-2 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 shadow-xl">
                                        <button class="bg-[#1ed760] rounded-full p-3 hover:scale-105 transition-transform text-black flex items-center justify-center">
                                            <i data-lucide="play" class="w-6 h-6 fill-black text-black ml-1"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1 min-h-[60px]">
                                    <h3 class="text-white font-bold truncate">${item.name}</h3>
                                    <p class="text-[#b3b3b3] text-sm line-clamp-2">By ${item.owner}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSearch(query = '') {
            if (!query) {
                // Browse All
                searchView.innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-4">Browse all</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        ${CATEGORIES.map(cat => `
                            <div class="${cat.color} aspect-[1.7] rounded-lg p-4 relative overflow-hidden cursor-pointer hover:opacity-90 transition-opacity">
                                <h3 class="text-2xl font-bold text-white max-w-[80%] break-words">${cat.name}</h3>
                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/2048px-Spotify_logo_without_text.svg.png" 
                                    class="absolute -bottom-4 -right-4 w-24 h-24 rotate-[25deg] shadow-lg grayscale opacity-50">
                            </div>
                        `).join('')}
                    </div>
                `;
                lucide.createIcons();
            } 
        }

        function renderSearchResults(results, query) {
             let html = `
                <div class="flex gap-2 mb-6">
                    <button class="px-3 py-1 bg-white text-black rounded-full text-sm font-medium">All</button>
                    <button class="px-3 py-1 bg-[#2a2a2a] text-white hover:bg-[#3a3a3a] rounded-full text-sm font-medium">Songs</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-[400px_1fr] gap-8 mb-8">
                `;

                if (results.length > 0) {
                    // Top Result
                    const top = results[0];
                    html += `
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-4">Top result</h2>
                        <div onclick="playSearchedSong(${top.id})" class="bg-[#181818] p-5 rounded-lg hover:bg-[#282828] transition-colors group cursor-pointer relative">
                            <img src="${top.cover}" class="h-24 w-24 rounded shadow-lg mb-4">
                            <h1 class="text-3xl font-bold text-white mb-2 line-clamp-1">${top.title}</h1>
                            <div class="flex items-center gap-2">
                                <span class="text-[#b3b3b3] text-sm font-medium">Song</span>
                                <span class="w-1 h-1 bg-white rounded-full"></span>
                                <span class="text-white text-sm font-medium line-clamp-1">${top.artist}</span>
                            </div>
                            <div class="absolute right-8 bottom-8 opacity-0 group-hover:opacity-100 transition-all translate-y-2 group-hover:translate-y-0">
                                <div class="bg-[#1ed760] p-3 rounded-full shadow-xl flex items-center justify-center">
                                    <i data-lucide="play" class="w-6 h-6 fill-black text-black ml-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-4">Songs</h2>
                        ${results.slice(0, 4).map((s, i) => `
                            <div onclick="playSearchedSong(${s.id})" class="group grid grid-cols-[16px_4fr_3fr_minmax(120px,1fr)] gap-4 px-4 py-2 text-sm text-[#b3b3b3] hover:bg-[#2a2a2a] rounded-md items-center cursor-default ${currentTrack.id == s.id ? 'text-[#1ed760]' : ''}">
                                <div class="flex items-center justify-center w-4 relative">
                                    <span class="group-hover:hidden ${currentTrack.id == s.id ? 'text-[#1ed760]' : 'text-[#b3b3b3]'}">${currentTrack.id == s.id && isPlaying ? '<img src="https://open.spotifycdn.com/cdn/images/equaliser-animated-green.f93a2ef4.gif" class="h-3 w-3">' : i + 1}</span>
                                    <span class="hidden group-hover:block text-white">
                                        <i data-lucide="${currentTrack.id == s.id && isPlaying ? 'pause' : 'play'}" class="w-4 h-4 text-white fill-white"></i>
                                    </span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <img src="${s.cover}" class="h-10 w-10 rounded shadow-md">
                                    <div class="flex flex-col">
                                        <span class="font-normal truncate text-base ${currentTrack.id == s.id ? 'text-[#1ed760]' : 'text-white'}">${s.title}</span>
                                        <span class="text-xs group-hover:text-white transition-colors">${s.artist}</span>
                                    </div>
                                </div>
                                <span class="hidden md:block hover:text-white hover:underline cursor-pointer truncate">${s.album}</span>
                                <div class="flex items-center justify-between">
                                    <span class="hidden group-hover:block"><i data-lucide="heart" class="w-4 h-4 hover:text-white cursor-pointer"></i></span>
                                    <span class="font-variant-numeric tabular-nums">${formatTime(s.duration)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                } else {
                    html += `<div class="text-white">No results found for "${query}"</div>`;
                }

                html += `</div>`;
                searchView.innerHTML = html;
                lucide.createIcons();

                // Store results for easy access
                window.lastSearchResults = results;
        }

        // --- AUDIO LOGIC ---
        
        // Updates UI immediately, doesn't start playing
        function loadTrackDataOnly(track) {
            // Update Text
            document.querySelectorAll('#player-title, #side-title, #fs-title').forEach(el => el.innerText = track.title);
            document.querySelectorAll('#player-artist, #side-artist, #fs-artist, #side-artist-name').forEach(el => el.innerText = track.artist);
            
            // Update Images
            document.querySelectorAll('#player-cover, #side-cover, #side-artist-img, #fs-cover').forEach(el => el.src = track.cover);
            
            // Update Time (Static)
            document.getElementById('total-time').innerText = formatTime(track.duration);
            document.getElementById('fs-total-time').innerText = formatTime(track.duration);
            
            // Update Home Gradient
            document.getElementById('home-gradient').className = `absolute top-0 left-0 w-full h-[350px] bg-gradient-to-b ${track.color || 'from-gray-700'} to-[#121212] opacity-40 pointer-events-none z-0 transition-colors duration-1000`;
            
            // Update Fullscreen Gradient
            document.getElementById('fs-gradient').className = `absolute inset-0 bg-gradient-to-b ${track.color || 'from-gray-800'} to-black opacity-90 pointer-events-none`;
        }

        // Loads track and triggers YT Player
        async function loadTrack(track) {
            currentTrack = track;
            loadTrackDataOnly(track);

            // If we don't have a YouTube ID yet, fetch it
            if (!track.youtubeId) {
                // Show loading state in player button if needed
                const fetchedId = await findYouTubeId(track);
                if (fetchedId) {
                    track.youtubeId = fetchedId;
                } else {
                    console.error("Could not find YouTube ID");
                    return;
                }
            }

            if (player && player.loadVideoById) {
                player.loadVideoById(track.youtubeId);
                // Video will autoplay due to loadVideoById
            }

            progress = 0;
            updateProgressUI();
            
            // Re-render search to update green text if active
            if(currentView === 'search' && searchInput.value) {
                 // Re-highlight
                 const btns = document.querySelectorAll('#search-view .text-[#1ed760]');
                 btns.forEach(b => b.classList.remove('text-[#1ed760]'));
            }
        }

        function playSong(id) {
            // For main list playback
            const track = SONGS.find(s => s.id === id);
            if (currentTrack.id === track.id) {
                togglePlay();
            } else {
                loadTrack(track);
            }
        }
        
        async function playSearchedSong(id) {
            if(!window.lastSearchResults) return;
            const track = window.lastSearchResults.find(s => s.id == id);
            
            if (currentTrack.id == track.id) {
                togglePlay();
            } else {
                await loadTrack(track);
                // Force update UI to show green
                searchITunes(searchInput.value); 
            }
        }

        function togglePlay() {
            if (!player) return;
            
            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function startTimer() {
            stopTimer(); // Clear existing
            progressInterval = setInterval(() => {
                if (player && player.getCurrentTime) {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    
                    if (duration > 0) {
                        progress = currentTime;
                        // document.getElementById('total-time').innerText = formatTime(duration); // Update total time from YT actual if needed
                        updateProgressUI(currentTime, duration);
                    }
                }
            }, 500);
        }

        function stopTimer() {
            clearInterval(progressInterval);
        }

        function playNext() {
            // Very simple logic: if in top hits, play next top hit
            const idx = SONGS.findIndex(s => s.id === currentTrack.id);
            if(idx !== -1) {
                const next = SONGS[(idx + 1) % SONGS.length];
                loadTrack(next);
            }
        }

        function playPrev() {
            const idx = SONGS.findIndex(s => s.id === currentTrack.id);
            if(idx !== -1) {
                const prev = SONGS[(idx - 1 + SONGS.length) % SONGS.length];
                loadTrack(prev);
            }
        }

        function updatePlayIcons() {
            const iconName = isPlaying ? 'pause' : 'play';
            // Main bar button
            const mainBtn = document.getElementById('btn-play-pause');
            mainBtn.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 fill-black text-black ml-0.5"></i>`;
            
            // FS button
            const fsBtn = document.getElementById('fs-play-btn');
            fsBtn.innerHTML = `<i data-lucide="${iconName}" class="w-8 h-8 fill-black ml-1"></i>`;
            
            lucide.createIcons();
        }

        function updateProgressUI(current, duration) {
            if (!duration) duration = currentTrack.duration; // Fallback
            if (!current) current = 0;

            const pct = (current / duration) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('fs-progress-bar').style.width = `${pct}%`;
            document.getElementById('current-time').innerText = formatTime(current);
            document.getElementById('fs-current-time').innerText = formatTime(current);
            document.getElementById('seek-slider').value = pct;
        }
        
        function updateVolumeUI() {
             const vol = document.getElementById('volume-slider').value;
             document.getElementById('volume-bar').style.width = `${vol}%`;
             if (player && player.setVolume) player.setVolume(vol);
             
             // Icon logic
             const icon = document.getElementById('volume-icon');
             // Simplistic icon update, normally would swap lucide icons
        }

        // --- UTILS ---
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 18) return 'Good afternoon';
            return 'Good evening';
        }

        function toggleRightSidebar() {
            const sb = document.getElementById('right-sidebar');
            sb.classList.toggle('hidden');
            sb.classList.toggle('flex');
        }

        function toggleFullScreen(show) {
            const fs = document.getElementById('fullscreen-overlay');
            if (show) {
                fs.classList.remove('hidden');
                fs.classList.add('flex');
            } else {
                fs.classList.add('hidden');
                fs.classList.remove('flex');
            }
        }
        
        // Seek Listener
        document.getElementById('seek-slider').addEventListener('input', (e) => {
            const pct = e.target.value;
            if (player && player.getDuration) {
                const duration = player.getDuration();
                const seekTo = (pct / 100) * duration;
                player.seekTo(seekTo, true);
            }
        });
        
        // Volume Listener
        document.getElementById('volume-slider').addEventListener('input', updateVolumeUI);

    </script>
</body>
</html>
